{% extends "base.html" %}
{% load static %}
{% block title %}Game{% endblock %}

{% block content %}
<div class="container d-flex justify-content-center align-items-center flex-column" style="color: #b4d9ec; padding: 10px;">

    <!-- Прогресс игры -->
    <div id="gameProgress" class="mb-4" style="width: 100%; max-width: 600px;">
        <div class="progress rounded-1" style="height: 10px; background-color: #4a9396;">
            <div id="progressBar" class="progress-bar" role="progressbar" style="width: 0%; background-color: #fdd03b;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
        </div>
    </div>

    <!-- Игровая область -->
    <div id="gameContainer" class="mt-4 p-4 rounded" style="width: 100%; max-width: 600px; background-color: rgba(180, 217, 236, 0.1); border: 2px solid #4a9396;"></div>

    <!-- Контейнер для алертов -->
    <div id="alertContainer" class="position-fixed bottom-0 end-0 p-3" style="z-index: 1050;"></div>

</div>
<style>
.audio-controls button {
    font-size: 1.2rem;
    padding: 10px 20px;
    border-radius: 5px;
}

.audio-controls .btn-primary {
    background-color: #4a9396;
    color: #fff;
}

.audio-controls .btn-secondary {
    background-color: #cb7f07;
    color: #fff;
}

.audio-controls i {
    margin-right: 8px;
}

        /* Анимация появления */
    .fade-in {
        opacity: 0;
        transition: opacity 0.5s ease-in-out;
    }

    /* Анимация исчезновения */
    .fade-out {
        opacity: 0;
        transition: opacity 0.5s ease-in-out;
    }

    /* Активное состояние (видимый элемент) */
    .visible {
        opacity: 1;
    }
</style>

<script>
// Инициализация игрового состояния
const gameState = {
    elements: {{ elements|safe }},
    currentIndex: 0,
    correctCount: 0
};

// Начало игры
function initializeGame() {
    if (gameState.elements.length > 0) {
        showElement(gameState.currentIndex);
    } else {
        alert("No game elements found");
    }
}

// Обновление прогресса игры
function updateProgress() {
    const progressBar = document.getElementById('progressBar');
    const totalElements = gameState.elements.length;
    const currentProgress = Math.round(((gameState.currentIndex + 1) / totalElements) * 100); // Добавляем +1 к индексу
    progressBar.style.width = `${currentProgress}%`;
    progressBar.setAttribute('aria-valuenow', currentProgress);
}

// Рендеринг элемента игры в зависимости от его типа
function showElement(index) {
    const element = gameState.elements[index];
    const gameContainer = document.getElementById('gameContainer');

    // Удаляем текущий элемент с эффектом fade-out
    gameContainer.classList.add('fade-out');
    setTimeout(() => {
        // После окончания анимации (500ms), очищаем контейнер
        gameContainer.innerHTML = '';

        // Обновляем прогресс
        updateProgress();

        // Рендерим элемент в зависимости от его типа
        if (element.type === 'sentence_order') {
            renderSentenceOrder(element);
        } else if (element.type === 'audio_sentence') {
            renderAudioSentence(element);
        } else if (element.type === 'word_translation') {
            renderWordTranslation(element);
        } else if (element.type === 'audio_word_translation') {
            renderAudioWordTranslation(element);
        } else if (element.type === 'word_origin') {
            renderWordOrigin(element);
        }

        // Плавное появление нового элемента
        gameContainer.classList.remove('fade-out');
        gameContainer.classList.add('fade-in', 'visible');
    }, 500); // Длительность анимации должна совпадать с transition из CSS
}

// Функция для озвучивания слова
function speakWord(word) {
    const utterance = new SpeechSynthesisUtterance(word);
    utterance.lang = 'de-DE'; // Немецкий язык
    utterance.rate = 1.3; // Скорость 1.5 для ускоренного воспроизведения
    window.speechSynthesis.speak(utterance);
}

// Рендеринг для типа 'sentence_order'
function renderSentenceOrder(element) {
    const gameContainer = document.getElementById('gameContainer');
    const words = element.german_sentence.split(' ');

    // Перемешиваем слова
    shuffleArray(words);

    // Добавляем контент с fade-in классом
    gameContainer.innerHTML = `
        <div class="fade-in visible">
            <h3 class="mb-4" style="color: #fdd03b;">Соберите предложение:</h3>
            <h3 class="mb-4 text-white p-3 rounded text-center" style="background-color: #4a9396;">${element.translation}</h3>

            ${element.image ? `<div class="d-flex justify-content-center mb-3">
                <img src="${element.image}" alt="Image" class="img-fluid" style="max-width: 100%; width: ${window.innerWidth >= 768 ? '300px' : '200px'}; height: auto;">
            </div>` : ''}

            <!-- Контейнер для ответа -->
            <div id="targetBox" class="border p-3 rounded mb-3" style="min-height: 100px; border-color: #b4d9ec;"></div>

            <!-- Контейнер для выбора слов -->
            <div id="wordsBox" class="border p-3 rounded mb-3" style="min-height: 100px; border-color: #b4d9ec;">
                ${words.map(word => `<button class="btn text-white m-1 word-button" style="background-color: #00202e;" onclick="moveWordToTarget('${word}', this)">${word}</button>`).join('')}
            </div>

            <button class="btn mt-2" style="background-color: #fdd03b; color: #00202e;" onclick="checkSentenceOrder('${element.german_sentence}')">Проверить</button>
        </div>
    `;
}

// Функция для перемещения слова из контейнера выбора в контейнер ответа (с озвучиванием)
function moveWordToTarget(word, btnElement) {
    const targetBox = document.getElementById('targetBox');
    const wordsBox = document.getElementById('wordsBox');

    // Добавляем слово в контейнер ответа
    const newWordElement = document.createElement('button');
    newWordElement.className = 'btn text-white m-1 word-button';
    newWordElement.style.backgroundColor = '#00202e';
    newWordElement.textContent = word;
    newWordElement.onclick = function () {
        moveWordBackToChoices(word, newWordElement); // Возвращение слова в контейнер выбора
    };
    targetBox.appendChild(newWordElement);

    // Удаляем слово из контейнера выбора
    wordsBox.removeChild(btnElement);

    // Озвучиваем слово при добавлении в контейнер ответа
    speakWord(word);
}

// Функция для перемещения слова обратно в контейнер выбора (без озвучивания)
function moveWordBackToChoices(word, btnElement) {
    const wordsBox = document.getElementById('wordsBox');
    const targetBox = document.getElementById('targetBox');

    // Добавляем слово обратно в контейнер выбора
    const newWordElement = document.createElement('button');
    newWordElement.className = 'btn text-white m-1 word-button';
    newWordElement.style.backgroundColor = '#00202e';
    newWordElement.textContent = word;
    newWordElement.onclick = function () {
        moveWordToTarget(word, newWordElement); // Добавляем обратно в контейнер ответа
    };
    wordsBox.appendChild(newWordElement);

    // Удаляем слово из контейнера ответа
    targetBox.removeChild(btnElement);
}


// Рендеринг для типа 'audio_sentence'
function renderAudioSentence(element) {
    const gameContainer = document.getElementById('gameContainer');
    gameContainer.innerHTML = `
    <div class="fade-in visible">
        <h3 class="mb-4">Что вы услышали?</h3>
        ${element.image ? `<div class="d-flex justify-content-center mb-3">
            <img src="${element.image}" alt="Image" class="img-fluid" style="max-width: 100%; width: ${window.innerWidth >= 768 ? '300px' : '200px'}; height: auto;">
        </div>` : ''}

        <div class="audio-controls d-flex justify-content-center mb-3">
            <!-- Кнопка с изображением без следов кнопки -->
            <button id="playNormal" class="me-3" onclick="playAudio('normal', '${element.audio}')" style="border: none; background: none; padding: 0;">
                <img id="playNormalImage" src="{% static 'img/sound_static.png' %}" alt="Play Normal" style="width: 40px; height: 40px;">
            </button>

            <button id="playSlow" class="ms-3" onclick="playAudio('slow', '${element.audio}')" style="border: none; background: none; padding: 0;">
                <img id="playSlowImage" src="{% static 'img/slow_sound.png' %}" alt="Play Slow" style="width: 40px; height: 40px;">
            </button>
        </div>

        <audio id="audioPlayer" src="${element.audio}" style="display: none;"></audio>
        <input type="text" class="form-control mb-3" id="userSentence" placeholder="Напишите предложение здесь">
        <button class="btn btn-primary" onclick="checkAudioSentence('${element.german_sentence}')">Проверить</button>
    </div>
    `;
}

// Рендеринг для типа 'word_translation'
function renderWordTranslation(element) {
    const gameContainer = document.getElementById('gameContainer');

    gameContainer.innerHTML = `
    <div class="fade-in visible">
        <h3 class="mb-4">Введите перевод слова "${element.german_word}":</h3>
        ${element.image ? `<div class="d-flex justify-content-center mb-3">
            <img src="${element.image}" alt="Image" class="img-fluid" style="max-width: 100%; width: ${window.innerWidth >= 768 ? '300px' : '200px'}; height: auto;">
        </div>` : ''}

        <input type="text" class="form-control mb-3" id="userTranslation" placeholder="Введите перевод">
        <button class="btn btn-primary" onclick="checkWordTranslation('${element.translation}')">Проверить</button>
    </div>
    `;
}

// Рендеринг для типа 'word_origin'
function renderWordOrigin(element) {
    const gameContainer = document.getElementById('gameContainer');
    gameContainer.innerHTML = `
    <div class="fade-in visible">
        <h3 class="mb-4">Введите перевод слова "${element.translation}":</h3>
        ${element.image ? `<div class="d-flex justify-content-center mb-3">
            <img src="${element.image}" alt="Image" class="img-fluid" style="max-width: 100%; width: ${window.innerWidth >= 768 ? '300px' : '200px'}; height: auto;">
        </div>` : ''}

        <input type="text" class="form-control mb-3" id="userGermanWord" placeholder="Введите перевод">
        <button class="btn btn-primary" onclick="checkWordOrigin('${element.german_word}')">Проверить</button>
    </div>
    `;
}

// Рендеринг для типа 'audio_word_translation'
function renderAudioWordTranslation(element) {
    const gameContainer = document.getElementById('gameContainer');
    gameContainer.innerHTML = `
    <div class="fade-in visible">
        <h3 class="mb-4">Как перевести?</h3>

        <div class="audio-controls d-flex justify-content-center mb-3">
            <button id="playNormal" class="me-3" onclick="playAudio('normal', '${element.audio}')" style="border: none; background: none; padding: 0;">
                <img id="playNormalImage" src="{% static 'img/sound_static.png' %}" alt="Play Normal" style="width: 40px; height: 40px;">
            </button>

            <button id="playSlow" class="ms-3" onclick="playAudio('slow', '${element.audio}')" style="border: none; background: none; padding: 0;">
                <img id="playSlowImage" src="{% static 'img/slow_sound.png' %}" alt="Play Slow" style="width: 40px; height: 40px;">
            </button>
        </div>

        <audio id="audioPlayer" src="${element.audio}" style="display: none;"></audio>
        <input type="text" class="form-control mb-3" id="userAudioTranslation" placeholder="Введите перевод">
        <button class="btn btn-primary" onclick="checkAudioWordTranslation('${element.translation}')">Проверить</button>
    </div>
    `;
}

// Функция для управления воспроизведением аудио
function playAudio(speed, audioUrl) {
    const audioPlayer = document.getElementById('audioPlayer');
    const playImage = document.getElementById('playNormalImage'); // Ваше изображение

    // Меняем изображение на GIF для анимации
    playImage.src = "{% static 'img/sound.gif' %}"; // Меняем на анимированный GIF

    // Фиксируем размер изображения для предотвращения изменения размеров
    playImage.style.width = '40px';
    playImage.style.height = '40px';

    // Если аудио уже воспроизводится, перезапускаем его с нужной скоростью
    if (!audioPlayer.src || audioPlayer.src !== audioUrl) {
        audioPlayer.src = audioUrl; // Загружаем аудиофайл
    }
    audioPlayer.currentTime = 0; // Перезапускаем аудио с начала

    // Устанавливаем скорость воспроизведения
    if (speed === 'normal') {
        audioPlayer.playbackRate = 1.0; // Нормальная скорость
        console.log("Playing at normal speed");
    } else if (speed === 'slow') {
        audioPlayer.playbackRate = 0.75; // Замедленная скорость
        console.log("Playing at slow speed (0.85)");
    }

    audioPlayer.play(); // Начинаем воспроизведение

    // Событие окончания аудио
    audioPlayer.onended = function() {
        playImage.src = "{% static 'img/sound_static.png' %}"; // Возвращаем статичное изображение после окончания
    };
}






// Обновление прогресса игры
function updateProgress() {
    const progressBar = document.getElementById('progressBar');
    const totalElements = gameState.elements.length;
    const currentProgress = Math.round(((gameState.currentIndex + 1) / totalElements) * 100); // Добавляем +1 к индексу
    progressBar.style.width = `${currentProgress}%`;
    progressBar.setAttribute('aria-valuenow', currentProgress);
}








//--------------------------------------------
// Функции для проверки правильности ответа
//--------------------------------------------

function showAlert(message, type) {
    const alertContainer = document.getElementById('alertContainer');
    const alert = document.createElement('div');

    // Создание Bootstrap алерта
    alert.className = `alert alert-${type} alert-dismissible fade show`;
    alert.role = "alert";
    alert.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    `;

    // Добавление алерта в контейнер
    alertContainer.appendChild(alert);

    // Удаление алерта через 1.5 секунды
    setTimeout(() => {
        alert.classList.remove('show');
        alert.classList.add('fade');
        setTimeout(() => alert.remove(), 150);
    }, 1500);
}





// Функция для нормализации строки: приведение к нижнему регистру и удаление неалфавитных символов
function normalizeText(text) {
    return text.toLowerCase().replace(/[^a-zа-яё0-9\s]/gi, '').replace(/\s+/g, ' ').trim();
}

// Проверка порядка слов в предложении
function checkSentenceOrder(correctSentence) {
    const userOrder = Array.from(document.getElementById('targetBox').children).map(el => el.textContent).join(' ');
    if (normalizeText(userOrder) === normalizeText(correctSentence)) {
        showAlert("Правильно!", "success");
        nextElement();
    } else {
        showAlert("Неправильно, попробуйте снова.", "danger");
    }
}

// Проверка предложений с помощью ввода текста
function checkAudioSentence(correctSentence) {
    const userSentence = document.getElementById('userSentence').value;
    if (normalizeText(userSentence) === normalizeText(correctSentence)) {
        showAlert("Правильно!", "success");
        nextElement();
    } else {
        showAlert("Неправильно, попробуйте снова.", "danger");
    }
}

// Проверка перевода слов
function checkWordTranslation(correctTranslation) {
    const userTranslation = document.getElementById('userTranslation').value;
    if (normalizeText(userTranslation) === normalizeText(correctTranslation)) {
        showAlert("Правильно!", "success");
        nextElement();
    } else {
        showAlert("Неправильно, попробуйте снова.", "danger");
    }
}

// Проверка перевода слов с аудио
function checkAudioWordTranslation(correctTranslation) {
    const userAudioTranslation = document.getElementById('userAudioTranslation').value;
    if (normalizeText(userAudioTranslation) === normalizeText(correctTranslation)) {
        showAlert("Правильно!", "success");
        nextElement();
    } else {
        showAlert("Неправильно, попробуйте снова.", "danger");
    }
}

// Проверка оригинальных слов
function checkWordOrigin(correctGermanWord) {
    const userGermanWord = document.getElementById('userGermanWord').value;
    if (normalizeText(userGermanWord) === normalizeText(correctGermanWord)) {
        showAlert("Правильно!", "success");
        nextElement();
    } else {
        showAlert("Неправильно, попробуйте снова.", "danger");
    }
}




// Переход к следующему элементу
function nextElement() {
    gameState.currentIndex++;
    if (gameState.currentIndex < gameState.elements.length) {
        showElement(gameState.currentIndex);
    } else {
        showAlert("Игра завершена!", "success");
    }
}

// Вспомогательная функция для перемешивания массива
function shuffleArray(array) {
    for (let i = array.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [array[i], array[j]] = [array[j], array[i]];
    }
}

// Запуск игры
initializeGame();

</script>
{% endblock %}